<!DOCTYPE html>
<html>
<head>
  <title>Fishing Spot Geofence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* Reset for full-screen experience */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #000; /* Fallback color */
    }
    /* Make the map fill the entire screen */
    #map {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    /* Fullscreen button styles */
    #fullscreen-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 10px 15px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      z-index: 1000;
    }
    #fullscreen-btn:hover {
      background-color: rgba(0, 0, 0, 0.7);
    }
  </style>
  
  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet RotatedMarker plugin -->
  <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>
  
  <!-- Firebase SDKs using ES6 modules -->
  <script type="module">
    // Import Firebase SDK modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getDatabase, ref, query, orderByChild, limitToLast, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDuD4-HahQRgpjSKOtiBr-7jPAv2FZ6IZY",
      authDomain: "boat-tracker-rc.firebaseapp.com",
      databaseURL: "https://boat-tracker-rc-default-rtdb.firebaseio.com",
      projectId: "boat-tracker-rc",
      storageBucket: "boat-tracker-rc.firebasestorage.app",
      messagingSenderId: "472171893970",
      appId: "1:472171893970:web:83064b37aa08da422a490b"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Global variables
    let map, marker, largeCircle;
    const sound = new Audio('sonar-beep_c_minor.wav');
    let hasPlayed = false;

    // Rotate the marker using the RotatedMarker plugin
    // We add a 180° offset so the arrow points the right way.
    function rotateMarker(heading) {
      // Adjust the heading by adding 180 degrees.
      const correctedHeading = (heading + 180) % 360;
      marker.setRotationAngle(correctedHeading);
    }

    function initMap() {
      const initialPosition = [-31.362293, -64.476401];

      // Create the map
      map = L.map('map').setView(initialPosition, 18);

      // Add satellite tiles
      L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        attribution: '© Google',
        maxZoom: 21
      }).addTo(map);

      // Use a Google arrow icon
      const arrowIcon = L.icon({
        iconUrl: 'arrow-icon.png',  // Google's arrow icon
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        popupAnchor: [0, -15]
      });

      // Add marker with the arrow icon and initialize rotationAngle to 0
      marker = L.marker(initialPosition, { icon: arrowIcon, rotationAngle: 0 }).addTo(map);

      // Define a large geofence (4 meters radius at a point to the east)
      const eastPosition = [initialPosition[0], initialPosition[1] + 0.00108];
      largeCircle = L.circle(eastPosition, {
        color: '#41A87B',
        fillColor: '#31805D',
        fillOpacity: 0.3,
        radius: 4
      }).addTo(map);

      // Enable sound playback on first user interaction
      document.body.addEventListener('click', () => {
        sound.play().catch(err => console.log('Sound playback failed:', err));
      }, { once: true });

      // Start fetching coordinates from Firebase
      fetchCoordinates();
    }

    // Utility: Check if a point is within a given radius of a center point
    function isWithinRadius(center, point, radius) {
      const distance = map.distance(center, point);
      return distance <= radius;
    }

    // Utility: Play sound multiple times with a given interval
    function playSoundMultipleTimes(sound, times, interval) {
      let count = 0;
      const playInterval = setInterval(() => {
        if (count < times) {
          sound.currentTime = 0;
          sound.play().catch(err => console.error("Sound play error:", err));
          count++;
        } else {
          clearInterval(playInterval);
        }
      }, interval);
    }

    // Fetch the latest coordinates from Firebase and update the marker
    function fetchCoordinates() {
      // Query for the most recent record in "boat_data"
      const boatDataRef = ref(database, 'boat_data');
      const recentDataQuery = query(boatDataRef, orderByChild('timestamp'), limitToLast(1));
      onValue(recentDataQuery, (snapshot) => {
        snapshot.forEach(child => {
          const data = child.val();
          console.log("Data received from Firebase:", data);
          if (data && data.latitude && data.longitude && data.heading !== undefined) {
            const newPosition = [parseFloat(data.latitude), parseFloat(data.longitude)];
            const heading = parseFloat(data.heading);

            console.log("New Position:", newPosition);
            console.log("Heading:", heading);

            // Update marker position
            marker.setLatLng(newPosition);
            // Rotate marker based on heading (with 180° correction)
            rotateMarker(heading);

            // Optionally play sound if within geofence
            if (isWithinRadius(largeCircle.getLatLng(), marker.getLatLng(), 4) && !hasPlayed) {
              playSoundMultipleTimes(sound, 5, 1000);
              hasPlayed = true;
            } else if (!isWithinRadius(largeCircle.getLatLng(), marker.getLatLng(), 4)) {
              hasPlayed = false;
            }

            // Optionally re-center the map
            map.setView(newPosition, 19);
          } else {
            console.error("Error: Data is missing latitude, longitude, or heading.");
          }
        });
      }, (error) => {
        console.error("Error fetching coordinates from Firebase:", error);
      });
    }

    // Initialize the map
    initMap();
  </script>
</head>
<body>
  <div id="map"></div>
  <button id="fullscreen-btn" onclick="toggleFullscreen()">Fullscreen</button>
</body>
</html>
